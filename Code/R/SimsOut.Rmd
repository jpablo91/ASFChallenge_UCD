---
title: "Simulations Output"
output: github_document
---


```{r global_options, include = FALSE}

knitr::opts_chunk$set(fig.width=12,
                      fig.height=8,
                      fig.path='../results/figs/test-summary/',
                      echo=FALSE, warning=FALSE, message=FALSE)

options(DT.options = list(pageLength = 100,
                          dom = 'Bft',
                          filter = "top",
                          buttons = c('copy', 'csv')))

```


```{r message = FALSE, warning = FALSE}
library(dplyr)
library(ggplot2)
library(ggpubr)
library(sf)
library(here)

out_dir = here("Results/Period_1")
if(!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)

# ==============================================================================
# FUNCTIONS
# ==============================================================================

# Read Simulations
# ------------------------------------------------------------------------------
ReadSims <- function(dir){
  f <- list.files(dir, full.names = TRUE)
  
  L <- lapply(1:length(f), function(x){
    read.csv(f[x], fileEncoding = 'UTF-8') %>%
      mutate(Sim = x)
    }) %>%
    do.call(rbind, .)
}


# Functions for getting quantiles
# ------------------------------------------------------------------------------
Q25 <- function(sims) quantile(sims, 0.25)
Q75 <- function(sims) quantile(sims, 0.75)


# Function for summarizing the cycles
# ------------------------------------------------------------------------------
CycleSums <- function(sims){
  sims %>%
    dplyr::select(-Sim) %>%
    group_by(cycle) %>%
    summarise_all(.funs = c(Median = median, Q25 = Q25, Q75 = Q75))
}


# Function for the plots
# ------------------------------------------------------------------------------
PlotCycles <- function(sims, var, col){
  y_lab = ifelse(grepl("_P", var), "Infected \n pigs", "Infected \n wild boar")
  sims %>%
    CycleSums() %>%
    ggplot(aes(x = cycle)) +
    geom_line(aes(y = eval(parse(text = paste0(var, '_Median')))),
      col = col, lwd = 1) +
    geom_ribbon(aes(
      ymin = eval(parse(text = paste0(var, '_Q25'))),
      ymax = eval(parse(text = paste0(var, '_Q75')))),
      alpha = 0.3, fill = col) +
    theme_minimal() +
    ylab(y_lab) +
    xlab("Days") +
    theme(legend.position = "none",
      axis.title.y = element_text(angle = 0, vjust = 0.5))
}


# Function to convert from long to wide
# ------------------------------------------------------------------------------
## Variable to spread categorical variables
unfold <- function(Dat, Var){
  Dat %>% mutate(N=1) %>% tidyr::spread(eval(parse(text = Var)), N, fill = 0)
}

```
  
### Variables from the 'EC' folder:  
  
  - *cycle:* time step of the simulation.  
  - *Infected_P:* Number of infected pig herds.  
  - *Infected_WB:* Number of infected wild Boars.  
  - *Sim:* Iteration of the simulation.  

<br><br>

# Scenario 0: Baseline
## Plot of infcted domestic pigs and wild bor over time

```{r}

S0 <- ReadSims(dir = here("Data/Period_1/Sims/S00/EC/"))

S0_pigs <- PlotCycles(S0, var = "Infected_P", col = "pink2")
S0_wb <- PlotCycles(S0, var = "Infected_WB", col = "brown")

S0_p = ggarrange(S0_pigs, S0_wb) %>%
  annotate_figure(top = text_grob("No. of infected animals over time\n",
    color = "darkred", face = "bold", size = 14))
    
S0_p

ggsave(file.path(out_dir, "fig_S0_infected-animals.png"), S0_p)
```


```{r, eval = FALSE}
S0_I <- S0 %>%
  group_by(Sim) %>%
  summarise(I_P = max(Infected_P)) %>%
  mutate(S = '00')
```


## Map 
  
Variables from the Agents folder:  
  - *idhex:* Id of the hexagonal cell.  
  - *Epidemic:* Number of times that there was an epidemic on that polygon.  
  - *introduction_ph:* Number of times that an infected pig was introduced to the polygon from other polygon.  
  - *introduction_wb:* Number of times the disease was transmitted from wild boars to a pig herd.  
    
    
```{r}

Hx_sim <- ReadSims(dir = here("Data/Period_1/Sims/S00/Agents/"))
Hx <- st_read(here("Data/Period_1/out/Hx.shp"), quiet = TRUE)

Hx_sim <- Hx_sim %>%
  mutate(idhex = as.character(idhex)) %>%
  unfold(., "Disease_status") %>%
  group_by(idhex) %>%
  summarise_at(.vars = c('Epidemic', 'introduction_ph', 'introduction_wb'), .funs = sum)

Hx %>%
  mutate(idhex = as.character(idhex)) %>%
  left_join(Hx_sim, by = 'idhex') %>%
  # filter(!is.na(Pop)) %>%
  mutate(Epidemic = ifelse(is.na(cases), Epidemic, 0)/80,
         index_case = ifelse(is.na(cases), NA, 1)) %>%
  ggplot() +
  geom_sf(aes(fill = Epidemic)) +
    geom_sf(data = subset(Hx, !is.na(cases)), fill = "red4")
    

```


# Scenario 01: Movement restrictions


```{r fig.height=3, fig.width=8}
S1 <- ReadSims(dir = "../../Data/Period_1/Sims/S01/EC/")

P1 <- PlotCycles(S1, var = "Infected_P", col = "pink2")
P2 <- PlotCycles(S1, var = "Infected_WB", col = "brown")

ggarrange(P1, P2)
```

```{r}
S1_I <- S1 %>%
  group_by(Sim) %>%
  summarise(I_P = max(Infected_P)) %>%
  mutate(S = '01')
```


## Map 
```{r}
Hx_sim01 <- ReadSims(dir = "../../Data/Period_1/Sims/S01/Agents/")

Hx_sim01 <- Hx_sim01 %>%
  mutate(idhex = as.character(idhex)) %>%
  unfold(., "Disease_status") %>%
  group_by(idhex) %>%
  summarise_at(.vars = c('Epidemic', 'introduction_ph', 'introduction_wb'), .funs = sum)

Hx %>%
  left_join(Hx_sim01, by = 'idhex') %>%
  # filter(!is.na(Pop)) %>%
  mutate(Epidemic = ifelse(is.na(cases), Epidemic, 0)/100,
         index_case = ifelse(is.na(cases), NA, 1)) %>%
  ggplot() +
  geom_sf(aes(fill = Epidemic)) +
  geom_sf(data = subset(Hx, !is.na(cases)), fill = "red4")
```

# Scenario 02: Movement restrictions and hunting pressure


```{r fig.height=3, fig.width=8}
S2 <- ReadSims(dir = "../../Data/Period_1/Sims/S02/EC/")

P1 <- PlotCycles(S2, var = "Infected_P", col = "pink2")
P2 <- PlotCycles(S2, var = "Infected_WB", col = "brown")

ggarrange(P1, P2)
```

```{r}
S2_I <- S2 %>%
  group_by(Sim) %>%
  summarise(I_P = max(Infected_P)) %>%
  mutate(S = '02')

rbind(S0_I, S1_I, S2_I) %>%
  ggplot(aes(y=I_P, fill = S)) +
  geom_boxplot()
```


## Map 
```{r}
Hx_sim02 <- ReadSims(dir = "../../Data/Period_1/Sims/S02/Agents/")

Hx_sim02 <- Hx_sim02 %>%
  mutate(idhex = as.character(idhex)) %>%
  unfold(., "Disease_status") %>%
  group_by(idhex) %>%
  summarise_at(.vars = c('Epidemic', 'introduction_ph', 'introduction_wb'), .funs = sum)

Hx %>%
  left_join(Hx_sim02, by = 'idhex') %>%
  # filter(!is.na(Pop)) %>%
  mutate(Epidemic = ifelse(is.na(cases), Epidemic, 0)/50,
         index_case = ifelse(is.na(cases), NA, 1)) %>%
  ggplot() +
  geom_sf(aes(fill = Epidemic)) +
  geom_sf(data = subset(Hx, !is.na(cases)), fill = "red4")
```



# Scenario 03: Movement restrictions, hunting pressure and fencing


```{r fig.height=3, fig.width=8}
S3 <- ReadSims(dir = "../../Data/Period_1/Sims/S03/EC/")

P1 <- PlotCycles(S2, var = "Infected_P", col = "pink2")
P2 <- PlotCycles(S2, var = "Infected_WB", col = "brown")

ggarrange(P1, P2)
```

```{r}
S3_I <- S3 %>%
  group_by(Sim) %>%
  summarise(I_P = max(Infected_P)) %>%
  mutate(S = '03')

rbind(S0_I, S1_I, S2_I, S3_I) %>%
  ggplot(aes(y=I_P, fill = S)) +
  geom_boxplot()
```


## Map 
```{r}
Hx_sim03 <- ReadSims(dir = "../../Data/Period_1/Sims/S02/Agents/")

Hx_sim03 <- Hx_sim03 %>%
  mutate(idhex = as.character(idhex)) %>%
  unfold(., "Disease_status") %>%
  group_by(idhex) %>%
  summarise_at(.vars = c('Epidemic', 'introduction_ph', 'introduction_wb'), .funs = sum)

Hx %>%
  left_join(Hx_sim03, by = 'idhex') %>%
  # filter(!is.na(Pop)) %>%
  mutate(Epidemic = ifelse(is.na(cases), Epidemic, 0)/50,
         index_case = ifelse(is.na(cases), NA, 1)) %>%
  ggplot() +
  geom_sf(aes(fill = Epidemic)) +
  geom_sf(data = subset(Hx, !is.na(cases)), fill = "red4")
```
